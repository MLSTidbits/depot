#!/usr/bin/env bash
# depot-config — Manage maintainer and GPG configuration for a depot repository.

# ────────────────────────────────────────────────
# Update configuration safely
# ────────────────────────────────────────────────
function update-conf () {
    local key="$1" val="$2"
    local pattern="^$key="

    [[ -z "$val" ]] && return 0

    if grep -qE "$pattern" "$CONFIG_PATH"; then
        sed -i "s|$pattern.*|$key=\"$val\"|" "$CONFIG_PATH"
    else
        echo "$key=\"$val\"" >> "$CONFIG_PATH"
    fi

}

# Uncomment for debugging
#set -xuo pipefail

appTitle="depot"
appVersion="$(cat doc/version 2>/dev/null || echo "unknown")"
verboseLib="/usr/lib/depot/verbose"

appInfo="$appTitle - $appVersion - Add/Modify maintainer and GPG signing configuration."

appHelp="$(cat <<- EOF
$appInfo

Usage: $appTitle config [--local|--global] <key>=<value> ...

Flags:
    -l, --local             Apply configuration to the current repository (default)
    -g, --global            Apply configuration globally (~/.depot/settings.conf)
    -h, --help              Show this help message and exit

Options:
    maintainer.name         The name of the package maintainer
    maintainer.email        The email address of the maintainer
    gpg.id                  The GPG key ID used for signing

Examples:
    $appTitle config --local  gpg.id=ABCDEF12
    $appTitle config --global maintainer.email=john@example.com
    $appTitle config maintainer.name="John Doe"

Notes:
    The config command can be run multiple times to update individual fields.

Copyright:
    2025 MLS Tidbits <contact@mlstidbits.com>
    2025 Michael Schaecher <michaelschaecher@mlstidbits.com>
License:
    GPLv3+ as published by the Free Software Foundation. All rights reserved.

EOF
)"

# Preflight checks
if [[ ! -x "$verboseLib" ]]; then
    echo "Error: verbose library not found at $verboseLib" >&2
    exit 1
fi

[[ $# -eq 0 ]] && { echo "$appHelp"; exit 0; }

MAINTAINER_NAME=""
MAINTAINER_EMAIL=""
GPG_KEY_ID=""

while [[ "$#" -gt "0" ]] ; do case "$1" in
        -l|--local              ) CONFIG_SCOPE="local"                   ; shift  ;;
        -g|--global             )
            CONFIG_SCOPE="global" ; mkdir -p "$HOME/.depot"
            shift
        ;;
        -h|--help               ) echo "$appHelp"                        ; exit 0 ;;
        *)
            [[ -z "$CONFIG_SCOPE" ]] && $verboseLib error "You must specify either --local or --global."

            [[ "$1" != *"\ "* ]] && $verboseLib error "Invalid argument format: '$1'. Use <key> <value>."

            for pair in "$@" ; do

                VALUE="$2"

                case "$pair" in
                    maintainer.name ) MAINTAINER_NAME="$VALUE"                    ;;
                    maintainer.email) MAINTAINER_EMAIL="$VALUE"                   ;;
                    gpg.id          ) GPG_KEY_ID="$VALUE"                         ;;
                    *               )
                        $verboseLib error "Unknown configuration key: '$1'"
                    ;;
                esac

            done

            break
        ;;
esac ; done

CONFIG_FILE="settings.conf"

if [[ "$CONFIG_SCOPE" == "local" ]]; then
    if [[ ! -d .depot ]]; then
        "$verboseLib" error "No local repository found. Run '$appTitle init' first."
        exit 1
    fi
    CONFIG_PATH=".depot/$CONFIG_FILE"
else
    CONFIG_PATH="$HOME/.depot/$CONFIG_FILE"
fi

touch "$CONFIG_PATH"

update-conf "MAINTAINER_NAME"  "$MAINTAINER_NAME"
update-conf "MAINTAINER_EMAIL" "$MAINTAINER_EMAIL"
update-conf "GPG_ID"           "$GPG_KEY_ID"

"$verboseLib" info "Configuration updated in $CONFIG_PATH"

exit 0
