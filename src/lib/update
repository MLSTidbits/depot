#!/usr/bin/env bash

# `update` Updates the package database and Release files of a Debian package repository.

# shellcheck disable=SC2155
function update-database () {

    local baseDir="${PWD}"

    local tempFile="$(mktemp /tmp/depot-packages.XXXXXX)"

    local genPackageFile="apt-ftparchive packages pool"

    local packageFile="$baseDir/dists/$suite/$components/binary-$arch/Packages"

    local releaseFile="${baseDir}/dists/$suite/Release"

    local inreleaseFile="${baseDir}/dists/$suite/InRelease"

    local genRelease="$(cat <<- EOL
Origin: $origin
Label: $label
Suite: $suite
Codename: $codename
Architectures: $arch
Version: 1.0
Components: $components
Description: $description
Maintainer: $maintainer
EOL
)"

    apt-ftparchive packages pool > "$packageFile" 2> /dev/null || {
    $verboseLib error "Failed to generate Packages file at $packageFile." ; exit 1; }

    [[ $? -gt 0 ]] && $verboseLib "error" "Failed to generate Packages file at $packageFile."

    [[ "$DRY_RUN" == "true" ]] && rm -f "$packageFile"

    for c in gzip bzip2 xz; do

        [[ "$DRY_RUN" == "true" ]] && break

        $c -k -f "$packageFile" || { $verboseLib \
        error "Failed to generate compressed Packages file at Packages.$c" ; exit 1; }

        $verboseLib info "Generated compressed Packages file at $packageFile.$c"

    done

    rm -f "$packageFile"

    local genReleaseHash="apt-ftparchive release"

    local releaseGPG="${baseDir}/$suite/Release.gpg"
    local inRelease="${baseDir}/$suite/InRelease"

    local gpgSign="gpg --default-key $key"

    echo "$genRelease" > "$releaseFile" || { $verboseLib \
    error "Failed to write Release file header to $releaseFile" ; exit 1; }

    apt-ftparchive release dists/"$suite" >> "$releaseFile" 2> /dev/null ||
    { $verboseLib error "Failed to generate Release file at $releaseFile." ; exit 1; }

    $verboseLib info "Generated Release file content."

    [[ "$DRY_RUN" == "true" ]] && return 0

    if [[ "$SIGN" == true || -n "$key" ]] ; then

        # Verify that the GPG key exists
        gpg --list-keys "$key" > /dev/null 2>&1 ||
        { $verboseLib error "GPG key '$key' not found. Cannot sign Release file." ; exit 1; }

        # Remove old signatures if they exist

        gpg --default-key "$key" \
            --output "$releaseFile.gpg" \
            --detach-sign "$releaseFile" 2> /dev/null ||
        { $verboseLib error "Failed creating detached signature at $releaseFile.gpg" ; exit 1; }

        $verboseLib info "Signed Release file and created detached signature at $releaseFile.gpg"

        gpg --default-key "$key" \
            --output "$inreleaseFile" \
            --clearsign "$releaseFile" 2> /dev/null ||
        { $verboseLib error "Failed creating $inreleaseFile" ; exit 1; }

        $verboseLib info "Signed Release file and created InRelease at $inRelease"

    fi

    return 0
}

# Uncomment for debugging
#set -xou pipefail

appName="depot"
appVersion="$(cat /usr/share/doc/depot/version 2>/dev/null || echo "unknown")"

verboseLib="/usr/lib/depot/verbose"

[[ ! -d .depot ]] &&
$verboseLib error "No repository found. Please run '$0 init' first to create a new repository."

/usr/lib/depot/verify-init

# Load configuration
source .depot/init 2> /dev/null ||
$verboseLib error "Failed to load repository configuration from .depot/init."

[[ -f "$HOME/.depot/settings.conf" ]] && source "$HOME/.depot/settings.conf" 2> /dev/null

[[ -f .depot/settings.conf ]] && source .depot/settings.conf 2> /dev/null

# Default values for optional settings
origin="${ORIGIN:-"Unknown"}"
label="${LABEL:-"default"}"
suite="${SUITE:-"stable"}"
codename="${CODENAME:-$suite}"
arch="${ARCH:-$(dpkg --print-architecture)}"
components="${COMPONENTS[*]:-"main"}"
description="${DESCRIPTION:-"Debian/Ubuntu package repository"}"
key="${GPG_ID:-""}"

maintainerName="${MAINTAINER_NAME:-"$USER"}"
maintainerEmail="${MAINTAINER_EMAIL:-"$(hostname)"}"

maintainer="$maintainerName <$maintainerEmail>"

DRY_RUN=false
SIGN=false

helpInfo="$(cat <<- EOL
$appName - $appVersion - Update the package database and Release files.
Usage: $appName update

Options:
    -d, --dry-run                   Show what would be done without making any changes.
    -s, --sign                      Sign the Release file with GPG: This is the default
                                    if GPG_KEY_ID is set.
    -D, --description DSC..         Update the description field in the Release file.
    -h, --help                      eShow this help message and exit.

Examples:
    $appName update
    $appName update --dry-run
    $appName update --sign
    $appName update --description "New description for the repository"

Note:
    The update command should be run after adding or removing packages to ensure
    the package database and Release files are current.

Copyright:
    2025 MLS Tidbits <contact@mlstidbits.com>
    2025 Michael Schaecher <michaelschaecher@mlstidbits.com>
License:
    GPLv3+ as published by the Free Software Foundation all rights reserved.
EOL
)"

# Preflight checks
[[ ! -x "$verboseLib" ]] && { echo "Error: verbose library not found at $verboseLib" >&2 ; exit 1 ;}

[[ $# -eq 0 ]] && { echo "$helpInfo"; exit 0; }

/usr/lib/depot/verify-init

while [[ $# -gt 0 ]]; do case "$1" in
    -d|--dry-run     ) DRY_RUN=true                  ; shift   ;;
    -s|--sign        ) SIGN=true                     ; shift   ;;
    -D|--description ) description="$2"              ; shift 2 ;;
    -h|--help        ) echo "$helpInfo"              ; exit 0  ;;
    -*               ) $verboseLib error "Unknown option: $1"  ;;
    *                ) break                                   ;;
esac ; done

update-database

exit 0
